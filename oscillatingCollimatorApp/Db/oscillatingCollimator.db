# (LET) Radial oscillating collimator

# Start/stop

record(bo, "$(P)$(O):START:SP") {
    field(DESC, "Start the code execution")
    field(FLNK, "$(P)$(O):START:SEQ")
}

record(seq, "$(P)$(O):START:SEQ") {
	field(DO1, "1")
	field(LNK1, "$(P)$(O):AXIS:CMD.PROC")
	
	field(DO2, "1")
	field(LNK2, "$(P)$(O):START:CMD.PROC")
	field(DLY2, "3.0")
	
	field(SELM, "All")
}

record(mbbi, "$(P)$(O):AXIS") {
	field(VAL, "$(AXIS)")
	field(PINI, "YES")
	field(ONST, "A")
	field(TWST, "B")
	field(THST, "C")
	field(FRST, "D")
	field(FVST, "E")
}

record(scalcout, "$(P)$(O):AXIS:CMD") {
	field(DESC, "Set axis in GMC")
	field(INAA, "$(P)$(O):AXIS")
	field(BB, "~a=\"")
	field(CC, "\"")
	field(CALC, "BB+AA+CC")
	field(OUT, "$(P)$(D):SEND_STR_CMD PP")
}

record(scalcout, "$(P)$(O):START:CMD") {
	field(INAA, "$(P)$(O):THREAD")
	field(BB, "XQ #HOMER,")
	field(CALC, "BB+AA")
	field(OUT, "$(P)$(D):SEND_STR_CMD PP")
}

record(scalcout, "$(P)$(O):START:CMD") {
	field(INAA, "$(P)$(O):THREAD")
	field(BB, "XQ #HOMER,")
	field(CALC, "BB+AA")
	field(OUT, "$(P)$(D):SEND_STR_CMD PP")
}

record(bo, "$(P)$(O):STOP:SP") {
    field(DESC, "Stop the code execution")
    field(FLNK, "$(P)$(O):STOP:SEQ")
}

record(seq, "$(P)$(O):STOP:SEQ") {
	field(DO1, "0.5")
	field(LNK1, "$(P)$(O):HALT:CMD.PROC")
	field(DLY1, "1")
	
	field(DO2, "1")
	field(LNK2, "$(P)$(O):STOP:CMD.PROC")
	field(DLY2, "1")
	
	field(SELM, "All")
}

record(scalcout, "$(P)$(O):HALT:CMD") {
	field(INAA, "$(P)$(O):THREAD")
	field(BB, "HX ")
	field(CALC, "BB+AA")
	field(OUT, "$(P)$(D):SEND_STR_CMD PP")
}

record(scalcout, "$(P)$(O):STOP:CMD") {
	field(BB, "ST")
	field(CALC, "BB")
	field(OUT, "$(P)$(D):SEND_STR_CMD PP")
}

# Motor position

record(ai, "$(P)$(O):POS:SP") {
    field(PREC, "2")
    field(EGU, "deg")
    field(VAL, "-1")
	field(FLNK, "$(P)$(O):POS:SP:_CALC")
}

record(calcout, "$(P)$(O):POS:SP:_CALC") {
	field(INPA, "$(P)$(O):POS:SP")
	field(INPB, "$(P)$(O):RADIUS:SP")
	field(CALC, "B*TAN(A/R2D)")
	field(OUT, "$(P)$(M).VAL PP")
	field(OOPT, "Every Time")
}

record(calcout, "$(P)$(O):POS:_CALC") {
	field(SCAN, "1 second")
	field(INPA, "$(P)$(M).RBV")
	field(INPB, "$(P)$(O):RADIUS:SP")
	field(CALC, "R2D*ATAN(A/B)")
	field(OUT, "$(P)$(O):POS PP")	
	field(OOPT, "Every Time")
}

record(ai, "$(P)$(O):POS") {
    field(PREC, "2")
    field(EGU, "deg")
}

alias("$(P)$(O):POS:SP", "$(P)$(O):POS:SP:RBV")

# Operating mode

record(ai, "$(P)$(O):MODE:_READ") {
	field(SCAN,"1 second")
	field(DTYP,"asynFloat64")
	field(PINI,"YES")
	field(EGU, "")
	field(FLNK,"$(P)$(O):MODE")
	field(INP, "@asyn(Galil,0)USER_VAR mode")
}

record(mbbi, "$(P)$(O):MODE") {
	field(DESC,"Control mode")
	field(INP, "$(P)$(O):MODE:_READ")
	field(ZRST, "Initializing")
	field(ONST, "Homing")
	field(TWST, "Oscillating")
}

# Frequency

record(ai, "$(P)$(O):FREQ:SP") {
    field(PREC, "2")
    field(EGU, "Hz")
	field(VAL, 1)
	field(FLNK, "$(P)$(O):ANGLE:_TRIG")
}

record(ai,"$(P)$(O):TIME") {
	field(DESC,"Time between oscillations")
	field(SCAN,"1 second")
	field(DTYP,"asynFloat64")
	field(INP, "@asyn(Galil,0)USER_VAR time")
	field(FLNK, "$(P)$(O):FREQ:_CALC")
}

record(calcout, "$(P)$(O):FREQ:_CALC") {
    field(PREC, "2")
    field(EGU, "Hz")
    field(INPA, "$(P)$(O):TIME")
	field(CALC, "1/A")
	field(OUT, "$(P)$(O):FREQ PP")
}

record(ai, "$(P)$(O):FREQ") {
    field(PREC, "2")
    field(EGU, "Hz")
}

# Cycle

record(ai,"$(P)$(O):CYCLE") {
	field(DESC,"Motor count")
	field(SCAN,"1 second")
	field(DTYP,"asynFloat64")
	field(INP, "@asyn(Galil,0)USER_VAR count")
    field(EGU, "")
    field(PREC, "0")
}

# Mounting radius

record(ai, "$(P)$(O):RADIUS:SP") {
    field(EGU, "mm")
    field(PREC, "2")
	field(VAL, 1)
	field(FLNK, "$(P)$(O):ANGLE:_TRIG")
}
alias("$(P)$(O):RADIUS:SP", "$(P)$(O):RADIUS")
alias("$(P)$(O):RADIUS:SP", "$(P)$(O):RADIUS:SP:RBV")

# Motor steps

record(calcout, "$(P)$(O):STEPS:_CALC") {
	field(SCAN, "1 second")
	field(INPA, "$(P)$(M).MRES")
	field(CALC, "1/A")
	field(OUT, "$(P)$(O):STEPS PP")
	field(EGU, "mm")
}

record(ai, "$(P)$(O):STEPS") {
	field(DESC, "Motor steps per mm")
    field(EGU, "1/mm")
    field(PREC, "0")
}

# Thread

record(stringin, "$(P)$(O):THREAD") {
    field(VAL, "2")
}
alias("$(P)$(O):THREAD", "$(P)$(O):THREAD:SP")
alias("$(P)$(O):THREAD", "$(P)$(O):THREAD:SP:RBV")

# Swept angle

record(ao, "$(P)$(O):ANGLE:SP") {
    field(EGU, "deg")
    field(PREC, "2")
	field(VAL, 1)
	field(FLNK, "$(P)$(O):ANGLE:_TRIG")
}
alias("$(P)$(O):ANGLE:SP", "$(P)$(O):ANGLE:SP:RBV")

record(fanout, "$(P)$(O):ANGLE:_TRIG") {
	field(LNK1, "$(P)$(O):DIST:PART:SP")
}

record(calc, "$(P)$(O):DIST:PART:SP") {
	field(INPA, "$(P)$(O):RADIUS:SP")
	field(INPB, "$(P)$(O):STEPS")
	field(INPC, "$(P)$(O):ANGLE:SP")
	field(CALC, "2*A*B*TAN(C*D2R)")
    field(EGU, "stp")
    field(PREC, "0")
	field(FLNK, "$(P)$(O):CYCLE:TIME:HALF:SP")
}

record(calc, "$(P)$(O):CYCLE:TIME:HALF:SP") {
	field(INPA, "$(P)$(O):FREQ:SP")
	field(CALC, "1/(2*A)")
    field(EGU, "s")
    field(PREC, "2")
	field(FLNK, "$(P)$(O):ACC:SP:_CALC")
}

record(calcout, "$(P)$(O):ACC:SP:_CALC") {
    field(EGU, "stp/s^2")
    field(PREC, "0")
	field(CALC, "49152")
	field(OUT, "$(P)$(O):ACC:SP PP")
	field(FLNK, "$(P)$(O):VEL:SP:DISC")
}

record(calc, "$(P)$(O):VEL:SP:DISC") {
	field(INPA, "$(P)$(O):ACC:SP")
	field(INPB, "$(P)$(O):DIST:PART:SP")
	field(INPC, "$(P)$(O):CYCLE:TIME:HALF:SP")
	field(CALC, "C*C-8*B/A")
	field(LOW, "0")
	field(LSV, "MAJOR")
    field(EGU, "")
    field(PREC, "0")
	field(FLNK, "$(P)$(O):VEL:SP:_CALC")
}

record(calcout, "$(P)$(O):VEL:SP:_CALC") {
	field(INPA, "$(P)$(O):ACC:SP")
	field(INPB, "$(P)$(O):DIST:PART:SP")
	field(INPC, "$(P)$(O):CYCLE:TIME:HALF:SP")
	field(INPD, "$(P)$(O):VEL:SP:DISC MS")
	field(CALC, "A*(C-SQR(MAX(D,0)))/4")
	field(OUT, "$(P)$(O):VEL:SP PP")
    field(EGU, "stp/s")
    field(PREC, "0")
	field(FLNK, "$(P)$(O):TIME:ACC:SP")
}

record(calc, "$(P)$(O):TIME:ACC:SP") {
	field(INPA, "$(P)$(O):ACC:SP")
	field(INPB, "$(P)$(O):VEL:SP MS")
	field(CALC, "B/A")
    field(EGU, "s")
    field(PREC, "2")
	field(FLNK, "$(P)$(O):TIME:VEL:SP")
}

record(calc, "$(P)$(O):TIME:VEL:SP") {
	field(INPA, "$(P)$(O):DIST:PART:SP")
	field(INPB, "$(P)$(O):VEL:SP MS")
	field(CALC, "A/B")
    field(EGU, "s")
    field(PREC, "2")
	field(FLNK, "$(P)$(O):TIME:TOTAL:SP")
}

record(calc, "$(P)$(O):TIME:TOTAL:SP") {
	field(INPA, "$(P)$(O):TIME:ACC:SP MS")
	field(INPB, "$(P)$(O):TIME:VEL:SP MS")
	field(CALC, "2*A+B")
    field(EGU, "s")
    field(PREC, "2")
	field(FLNK, "$(P)$(O):DIST:VEL:SP")
}

record(calc, "$(P)$(O):DIST:VEL:SP") {
	field(INPA, "$(P)$(O):ACC:SP")
	field(INPB, "$(P)$(O):VEL:SP MS")
	field(CALC, "B*B/A")
    field(EGU, "stp")
    field(PREC, "2")
	field(FLNK, "$(P)$(O):DIST:SP:_CALC")
}

record(calcout, "$(P)$(O):DIST:SP:_CALC") {
	field(INPA, "$(P)$(O):DIST:VEL:SP MS")
	field(INPB, "$(P)$(O):DIST:PART:SP")
	field(CALC, "2*A+B")
	field(OUT, "$(P)$(O):DIST:SP PP")
    field(EGU, "stp")
    field(PREC, "2")
}
	
# Calculate the actual swept distance

record(fanout, "$(P)$(O):ANGLE:INV:_TRIG") {
	field(SCAN, "1 second")
	field(LNK1, "$(P)$(O):DIST:VEL")
}

record(calc, "$(P)$(O):DIST:VEL") {
    field(EGU, "stp")
    field(PREC, "0")
	field(INPA, "$(P)$(O):ACC")
	field(INPB, "$(P)$(O):VEL")
	field(CALC, "B*B/A")
	field(FLNK, "$(P)$(O):DIST:PART")
}

record(calc, "$(P)$(O):DIST:PART") {
    field(EGU, "stp")
    field(PREC, "0")
	field(INPA, "$(P)$(O):DIST")
	field(INPB, "$(P)$(O):DIST:VEL")
	field(CALC, "A-2*B")
	field(FLNK, "$(P)$(O):ANGLE")
}

record(calc, "$(P)$(O):ANGLE") {
    field(EGU, "deg")
    field(PREC, "2")
	field(INPA, "$(P)$(O):DIST:PART")
	field(INPB, "$(P)$(O):RADIUS")
	field(INPC, "$(P)$(O):STEPS")
	field(CALC, "R2D*ATAN(A/(2*B*C))")
	field(FLNK, "$(P)$(O):CYCLE:TIME:HALF")
}

record(calc, "$(P)$(O):CYCLE:TIME:HALF") {
    field(EGU, "s")
    field(PREC, "2")
	field(INPA, "$(P)$(O):ACC")
	field(INPB, "$(P)$(O):VEL")
	field(INPC, "$(P)$(O):DIST")
	field(CALC, "2*B/A+C/B")
	field(FLNK, "$(P)$(O):FREQ:SP:RBV")
}

record(calc, "$(P)$(O):FREQ:SP:RBV") {
    field(EGU, "Hz")
    field(PREC, "2")
	field(INPA, "$(P)$(O):CYCLE:TIME:HALF")
	field(CALC, "1/(2*A)")
}

# The fields set by the calculations

record(ao,"$(P)$(O):VEL:SP") {
	field(DESC, "Velocity setpoint")
	field(DTYP, "asynFloat64")	
	field(EGU, "stp/s")
	field(PREC, "2")
	field(PINI,"YES")
	field(OUT, "@asyn(Galil,0)USER_VAR vel")
}

record(ao,"$(P)$(O):ACC:SP") {
	field(DESC, "Acceleration setpoint")
	field(VAL, "49152")
	field(DTYP, "asynFloat64")	
	field(EGU, "stp/s^2")
	field(PREC, "2")
	field(PINI,"YES")
	field(OUT, "@asyn(Galil,0)USER_VAR accel")
}

record(ao,"$(P)$(O):DIST:SP") {
	field(DESC, "Total swept distance setpoint")
	field(DTYP, "asynFloat64")	
	field(EGU, "stp")
	field(PREC, "2")
	field(PINI,"YES")
	field(OUT, "@asyn(Galil,0)USER_VAR dist")
}

# Recover the variables set in the Galil

record(ai,"$(P)$(O):VEL") {
	field(DESC,"Velocity")
	field(SCAN,"1 second")
	field(DTYP,"asynFloat64")
	field(INP, "@asyn(Galil,0)USER_VAR vel")
    field(EGU, "stp/s")
    field(PREC, "2")
	field(PINI,"YES")
}
	
record(ai,"$(P)$(O):ACC") {
	field(DESC,"Acceleration")
	field(SCAN,"1 second")
	field(DTYP,"asynFloat64")
	field(INP, "@asyn(Galil,0)USER_VAR accel")
    field(EGU, "stp/s^2")
    field(PREC, "2")
	field(PINI,"YES")
}
	
record(ai,"$(P)$(O):DIST") {
	field(DESC,"Total swept distance")
	field(SCAN,"1 second")
	field(DTYP,"asynFloat64")
	field(INP, "@asyn(Galil,0)USER_VAR dist")
    field(EGU, "stp")
    field(PREC, "2")
	field(PINI,"YES")
}
