# XY Beamstop Soft motor record
#
#  Record that allows calculation of the XY position of a beamstop
#  from w-theta coordinates. For more info see the wiki.
#
#  Macros:
#    P - base name for ioc
#    MTR1 - the IOC postfix of the motor that is being used to drive the horizontal axis
#    MTR2 - the IOC postfix of the motor that is being used to drive the vertical axis
#    ARMLEN - the length of the arm attached to the horizontal axis
#    SHUTTER_PORT - the name of the digital port used to open and close the shutter
#    X_OFFSET -  the X-Y coordinate offset from the motors 0 positions
#    Y_OFFSET -  the X-Y coordinate offset from the motors 0 positions
#    X_MAX_LIMIT - the highest value x can take
#    X_MIN_LIMIT - the lowest value x can take
#    Y_MAX_LIMIT - the highest value y can take 
#    Y_MIN_LIMIT - the lowest value y can take 

# Conversion records from x-y to w-theta coordinate system

record(transform, "$(P)FROMTHETA") {
    field(DESC,"Convert theta to motor axis")
    field(ASG, "READONLY")

    field(CLCB, "A")
    field(OUTB, "$(P)$(MTR1).DVAL  PP MS")
}

record(transform, "$(P)TOWTHETA") {
    field(DESC,"Convert X-Y to W-Theta")
    field(ASG, "READONLY")
    field(INPC, "$(ARMLEN)")

    field(CLCD, "ASIN(B/C)")
    field(CLCE, "A - SQRT(C**2 - B**2)")

    field(OUTD, "$(P)FROMTHETA.A  PP MS")
    field(OUTE, "$(P)$(MTR2).DVAL  PP MS")
}

# Conversion records from w-theta to x-y coordinate system

record(transform, "$(P)TOTHETA") {
    field(DESC,"Convert from motor axis to theta")
    field(ASG, "READONLY")

    field(INPA, "$(P)$(MTR1).DRBV CP MS")
    field(CLCB, "A")
}

record(transform, "$(P)TOXY") {
	field(DESC, "Convert W-Theta to X-Y") 
    field(ASG, "READONLY")

    field(INPA, "$(P)TOTHETA.B CP MS")
    field(INPB, "$(P)$(MTR2).DRBV CP MS")
    field(INPC, "$(ARMLEN)")

    field(CLCD, "COS(A)*C + B")
    field(CLCE, "SIN(A)*C")
}


# We need these two record to propagate the STOP and DMOV
# status of the underlying motors to the simulated motor axes
record(transform, "$(P)ARM:MOTORS:STOP") {
    
    field(CLCC, "A || B")
    field(CLCD, "A || B")

    field(OUTC, "$(P)$(MTR1).STOP PP")
    field(OUTD, "$(P)$(MTR2).STOP PP")

    field(PINI, "YES")
}

record(calc, "$(P)ARM:MOTORS:DMOV") {
    field(SCAN, "Passive")
    field(INPA, "$(P)$(MTR1).DMOV CP")
    field(INPB, "$(P)$(MTR2).DMOV CP")

    field(CALC, "A && B")

    # Must include MDEL to avoid a race condition when setting
    # either of the soft motors to the position they're already at
    field(MDEL, "-1") 
    field(PINI, "YES")
}

# X-Y Motor Records

record(motor, "$(P)ARM:X") 
{ 
    field(DESC, "X axis position")
    field(SCAN, "Passive")
    field(DTYP,"Soft Channel") 
    field(OUT,"$(P)TOWTHETA.A PP MS") 
    field(RDBL,"$(P)TOXY.A  CP MS") 
    field(STOO,"$(P)ARM:MOTORS:STOP.A  PP MS") 
    field(DINP,"$(P)ARM:MOTORS:DMOV CP MS") 
    field(OFF, "$(X_OFFSET)")
    field(LLM, "$(X_MIN_LIMIT)")
    field(HLM, "$(X_MAX_LIMIT)")
    field(DLLM, "$(X_MIN_LIMIT)")
    field(DHLM, "$(X_MAX_LIMIT)")
    field(URIP, "Yes") 
    field(MRES,"0.001") 
    field(RRES,"1.000") 
    field(PREC,"3") 
    field(TWV,"5") 
    field(RTRY,"0") 
    field(EGU,"mm") 
    info(INTEREST, "HIGH")
    info(archive,"0.02 VAL RBV DVAL OFF MSTA DIR CNEN MOVN DMOV")
	info(alarm,"Motors")
}

alias("$(P)ARM:X", "$(P)ARM:X:SP")
alias("$(P)ARM:X", "$(P)ARM:X:SP:RBV")

record(motor,"$(P)ARM:Y") 
{ 
    field(DESC, "Y axis position")
    field(SCAN, "Passive")
    field(DTYP,"Soft Channel") 
    field(OUT,"$(P)TOWTHETA.B PP MS") 
    field(RDBL,"$(P)TOXY.B  CP MS") 
    field(STOO,"$(P)ARM:MOTORS:STOP.B  PP MS") 
    field(DINP,"$(P)ARM:MOTORS:DMOV CP MS") 
    field(OFF, "$(Y_OFFSET)")
    field(LLM, "$(Y_MIN_LIMIT)")
    field(HLM, "$(Y_MAX_LIMIT)")
    field(DLLM, "$(Y_MIN_LIMIT)")
    field(DHLM, "$(Y_MAX_LIMIT)")
    field(URIP, "Yes") 
    field(MRES,"0.001") 
    field(RRES,"1.000") 
    field(PREC,"3") 
    field(TWV,"5") 
    field(RTRY,"0") 
    field(EGU,"mm") 
    info(INTEREST, "HIGH")
    info(archive,"0.02 VAL RBV DVAL OFF MSTA DIR CNEN MOVN DMOV")
	info(alarm,"Motors")
}

alias("$(P)ARM:Y", "$(P)ARM:Y:SP")
alias("$(P)ARM:Y", "$(P)ARM:Y:SP:RBV")

record(bo, "$(P)ARM:STORE:SP") {
    field(ZNAM, "ACTIVE")
    field(ONAM, "STORED")
    field(DTYP, "Raw Soft Channel")
    field(FLNK, "$(P)ARM:STORE:CALC")
    field(VAL, "0")
    field(PINI, "YES")
}

alias("$(P)ARM:STORE:SP", "$(P)ARM:STORE")

record(transform, "$(P)ARM:STORE:CALC") {
    field(INPA, "$(P)ARM:STORE:SP")

    # Add/remove limits so we can move to active/store position
    field(CLCB, "(A=1) ? -999 : $(X_MIN_LIMIT)")
    field(CLCC, "(A=1) ? -999 : $(X_MIN_LIMIT)")
    field(CLCD, "(A=1) ? 999 : $(X_MAX_LIMIT)")
    field(CLCE, "(A=1) ? 999 : $(X_MAX_LIMIT)")

    # Move to store/active position
    field(CLCF, "(A=1) ? $(STORE_X) : $(ACTIVE_X)")
    field(CLCG, "(A=1) ? $(STORE_Y) : $(ACTIVE_Y)")

    # Enable/disable put access to X/Y motors
    field(CLCH, "A")
    field(CLCI, "A")

    field(OUTB, "$(P)ARM:X.LLM PP MS")
    field(OUTC, "$(P)ARM:X.DLLM PP MS")
    field(OUTD, "$(P)ARM:X.HLM PP MS")
    field(OUTE, "$(P)ARM:X.DHLM PP MS")

    field(OUTF, "$(P)ARM:X PP MS")
    field(OUTG, "$(P)ARM:Y PP MS")

    field(OUTH, "$(P)ARM:X.DISP PP MS")
    field(OUTI, "$(P)ARM:Y.DISP PP MS")
}

# Beamstop Shutters
record(bo, "$(P)SHUTTERS:SP") {
    field(ZNAM, "CLOSED")
    field(ONAM, "OPEN")
    field(DTYP, "Raw Soft Channel")
    field(FLNK, "$(P)$(SHUTTER_PORT)")
}

alias("$(P)SHUTTERS:SP", "$(P)SHUTTERS")
