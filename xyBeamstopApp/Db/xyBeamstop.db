# XY Beamstop Soft motor record
#
#  Record that allows calculation of the XY position of a beamstop
#  from w-theta coordinates. For more info see the wiki.
#
#  Macros:
#    P - base name for ioc
#    MTR1 - the IOC postfix of the motor that is being used to drive the horizontal axis
#    MTR2 - the IOC postfix of the motor that is being used to drive the vertical axis
#    ARMLEN - the length of the arm attached to the horizontal axis
#    SHUTTER_PORT - the name of the digital port used to open and close the shutter
#    X_OFFSET -  the X-Y coordinate offset from the motors 0 positions
#    Y_OFFSET -  the X-Y coordinate offset from the motors 0 positions
#    X_MAX_LIMIT - the highest value x can take
#    X_MIN_LIMIT - the lowest value x can take
#    Y_MAX_LIMIT - the highest value y can take 
#    Y_MIN_LIMIT - the lowest value y can take 

# Set limits on motor records
record(motor, "$(P)$(MTR1)") {
    field(LLM, "$(THETA_MIN_LIMIT)")
    field(HLM, "$(THETA_MAX_LIMIT)")
    field(DLLM, "$(THETA_MIN_LIMIT)")
    field(DHLM, "$(THETA_MAX_LIMIT)")
}

record(motor, "$(P)$(MTR2)") {
    field(LLM, "$(W_MIN_LIMIT)")
    field(HLM, "$(W_MAX_LIMIT)")
    field(DLLM, "$(W_MIN_LIMIT)")
    field(DHLM, "$(W_MAX_LIMIT)")
}

# Conversion records from x-y to w-theta coordinate system

record(transform, "$(P)FROMTHETA") {
    field(DESC,"Convert theta to motor axis")
    field(ASG, "READONLY")

    field(CLCB, "A")
    field(OUTB, "$(P)$(MTR1).DVAL  PP MS")
}

record(transform, "$(P)TOTHETA") {
    field(DESC,"Convert from motor axis to theta")
    field(ASG, "READONLY")

    field(INPA, "$(P)$(MTR1).DRBV CP MS")
    field(CLCB, "A")
}

# Conversion record between w-theta and x-y coordinate system

record(transform, "$(P)CONVERTXY") {
	field(DESC, "Transform X then Y") 
    field(ASG, "READONLY")

    field(INPA, "$(P)TOTHETA.B CP MS")
    field(INPB, "$(P)$(MTR2).DRBV CP MS")
    field(INPE, "$(ARMLEN)")

    field(CLCF, "COS(A)*E + B")
    field(CLCG, "SIN(A)*E")
    field(CLCH, "ASIN(D/E)")
    field(CLCI, "C - SQRT(E**2 - D**2)")

    field(OUTH, "$(P)FROMTHETA.A PP")
    field(OUTI, "$(P)$(MTR2).DVAL PP")
}


# We need these two record to propagate the STOP and DMOV
# status of the underlying motors to the simulated motor axes
record(transform, "$(P)ARM:MOTORS:STOP") {
    
    field(CLCC, "A || B")
    field(CLCD, "A || B")

    field(OUTC, "$(P)$(MTR1).STOP PP")
    field(OUTD, "$(P)$(MTR2).STOP PP")

    field(PINI, "YES")
}

record(calc, "$(P)ARM:MOTORS:DMOV") {
    field(SCAN, "Passive")
    field(INPA, "$(P)$(MTR1).DMOV CP")
    field(INPB, "$(P)$(MTR2).DMOV CP")

    field(CALC, "A && B")

    # Must include MDEL to avoid a race condition when setting
    # either of the soft motors to the position they're already at
    field(MDEL, "-1") 
    field(PINI, "YES")
}

# X-Y Motor Records

record(motor, "$(P)ARM:X") 
{ 
    field(LOCK, "YES")
    field(DESC, "X axis position")
    field(SCAN, "Passive")
    field(DTYP, "Soft Channel") 
    field(OUT, "$(P)CONVERTXY.C PP MS") 
    field(RDBL, "$(P)CONVERTXY.F CP MS") 
    field(STOO, "$(P)ARM:MOTORS:STOP.A  PP MS") 
    field(DINP, "$(P)ARM:MOTORS:DMOV CP MS") 
    field(OFF, "$(X_OFFSET)")
    field(URIP, "Yes") 
    field(MRES,"0.001") 
    field(RRES,"1.000") 
    field(PREC,"3") 
    field(TWV,"5") 
    field(RTRY,"0") 
    field(EGU,"mm") 
    info(INTEREST, "HIGH")
    info(archive,"0.02 VAL RBV DVAL OFF MSTA DIR CNEN MOVN DMOV")
	info(alarm,"Motors")
}

alias("$(P)ARM:X", "$(P)ARM:X:SP")
alias("$(P)ARM:X", "$(P)ARM:X:SP:RBV")

record(motor,"$(P)ARM:Y") 
{ 
    field(LOCK, "YES")
    field(DESC, "Y axis position")
    field(SCAN, "Passive")
    field(DTYP,"Soft Channel") 
    field(OUT, "$(P)CONVERTXY.D PP MS") 
    field(RDBL,"$(P)CONVERTXY.G CP MS") 
    field(STOO,"$(P)ARM:MOTORS:STOP.B  PP MS") 
    field(DINP,"$(P)ARM:MOTORS:DMOV CP MS") 
    field(OFF, "$(Y_OFFSET)")
    field(URIP, "Yes") 
    field(MRES,"0.001") 
    field(RRES,"1.000") 
    field(PREC,"3") 
    field(TWV,"5") 
    field(RTRY,"0") 
    field(EGU,"mm") 
    info(INTEREST, "HIGH")
    info(archive,"0.02 VAL RBV DVAL OFF MSTA DIR CNEN MOVN DMOV")
	info(alarm,"Motors")
}

alias("$(P)ARM:Y", "$(P)ARM:Y:SP")
alias("$(P)ARM:Y", "$(P)ARM:Y:SP:RBV")


record(ao, "$(P)ARM:X:TWEAK") {
    field(DESC, "Move arm X relative")
    field(VAL, "0")
    field(FLNK, "$(P)ARM:X:TWEAK:CALC")
    field(PREC,"3") 
    field(EGU,"mm") 
    info(INTEREST, "HIGH")
}
alias("$(P)ARM:X:TWEAK", "$(P)ARM:X:TWEAK:SP")

record(calcout, "$(P)ARM:X:TWEAK:CALC") {
    field(INPA, "$(P)ARM:X.VAL")
    field(INPB, "$(P)ARM:X:TWEAK.VAL")

    field(CALC, "A + B")
    field(OUT, "$(P)ARM:X PP")
}

record(calcout, "$(P)ARM:X:TWEAK:DECREMENT") {
    field(INPA, "$(P)ARM:X.VAL")
    field(INPB, "$(P)ARM:X:TWEAK.VAL")

    field(CALC, "A - B")
    field(OUT, "$(P)ARM:X PP")
}

record(ao, "$(P)ARM:Y:TWEAK") {
    field(DESC, "Move arm Y relative")
    field(VAL, "0")
    field(FLNK, "$(P)ARM:Y:TWEAK:CALC")
    field(PREC,"3") 
    field(EGU,"mm") 
    info(INTEREST, "HIGH")
}

alias("$(P)ARM:Y:TWEAK", "$(P)ARM:Y:TWEAK:SP")

record(calcout, "$(P)ARM:Y:TWEAK:CALC") {

    field(INPA, "$(P)ARM:Y.VAL")
    field(INPB, "$(P)ARM:Y:TWEAK.VAL")

    field(CALC, "A + B")
    field(OUT, "$(P)ARM:Y PP")
}

record(calcout, "$(P)ARM:Y:TWEAK:DECREMENT") {
    field(INPA, "$(P)ARM:Y.VAL")
    field(INPB, "$(P)ARM:Y:TWEAK.VAL")

    field(CALC, "A - B")
    field(OUT, "$(P)ARM:Y PP")
}

record(bo, "$(P)ARM:STORE:SP") {
    field(ZNAM, "ACTIVE")
    field(ONAM, "STORED")
    field(DTYP, "Raw Soft Channel")
    field(FLNK, "$(P)ARM:STORE:CALC")
    field(VAL, "0")
    field(PINI, "YES")
}

alias("$(P)ARM:STORE:SP", "$(P)ARM:STORE")

record(calc, "$(P)ARM:STORE:INV") {
    field(INPA, "$(P)ARM:STORE:SP CP")
    field(CALC, "!A")
}

record(transform, "$(P)ARM:STORE:CALC") {
    field(INPA, "$(P)ARM:STORE:SP")

    # Add/remove limits so we can move to active/store position

    # Move to store/active position
    field(CLCB, "(A=1) ? $(STORE_X) : $(ACTIVE_X)")
    field(CLCC, "(A=1) ? $(STORE_Y) : $(ACTIVE_Y)")

    # Enable/disable put access to X/Y motors
    field(CLCD, "A")
    field(CLCE, "A")

    field(OUTB, "$(P)ARM:X PP MS")
    field(OUTC, "$(P)ARM:Y PP MS")

    field(OUTD, "$(P)ARM:X.DISP PP MS")
    field(OUTE, "$(P)ARM:Y.DISP PP MS")
}

# Beamstop Shutters
record(bo, "$(P)SHUTTERS:SP") {
    field(VAL, "0")
    field(PINI, "YES")
    field(ZNAM, "CLOSED")
    field(ONAM, "OPEN")
    field(DTYP, "Raw Soft Channel")
    field(FLNK, "$(P)$(SHUTTER_PORT)")
}

record(calc, "$(P)SHUTTERS:INV") {
    field(INPA, "$(P)SHUTTERS:SP CP")
    field(CALC, "!A")
}

alias("$(P)SHUTTERS:SP", "$(P)SHUTTERS")
