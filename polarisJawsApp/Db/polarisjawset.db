# Polaris jaw set Soft motor record
#
#  Record that allows calculation of the gaps and centre of jaws set 1-4 which are under user control
#  Also provides management access to set jaw set 5. For more info see the wiki
#
#  Macros:
#    P - base name for ioc
#    COL_HEIGHT - Height of the collimator
#    COL_WIDTH  - Width of the collimator
#    MOD_TO_SAMPLE - Dist from moderator to sample
#    MOD_TO_JAWSX - (X 1 to 5) Distance from moderator to jaw set X
#


record(ai, "$(P)POLJAWSET:HGAP:SP") {
  field(DESC, "Set width at the sample")
  field(PREC, "2")
  field(FLNK, "$(P)POLJAWSET:HGAP:_FAN")
  field(EGU, "")
  info(archive, "VAL")
}

record(ai, "$(P)POLJAWSET:VGAP:SP") {
  field(DESC, "Set height at the sample")
  field(PREC, "2")
  field(FLNK, "$(P)POLJAWSET:VGAP:_FAN")
  field(EGU, "")
  info(archive, "VAL")
}

record(transform, "$(P)POLJAWSET:HGAP:_FAN") {

  field(INPA, "$(P)POLJAWSET:HGAP:SP")
  field(INPB, "$(P)MOT:JAWS5:HGAP:SP")
  field(INPC, "$(COL_WIDTH)")
  field(INPD, "$(MOD_TO_SAMPLE)")
  field(INPE, "$(MOD_TO_COL)")
  field(INPF, "$(MOD_TO_JAWS1)")
  field(INPG, "$(MOD_TO_JAWS2)")
  field(INPH, "$(MOD_TO_JAWS3)")
  field(INPI, "$(MOD_TO_JAWS4)")
  field(INPJ, "$(MOD_TO_JAWS5)")  
  
  field(CLCK, "(A+((C-A)*((D-F)/(D-E))))") # Jaw set 1
  field(CLCL, "(A+((C-A)*((D-G)/(D-E))))") # Jaw set 2
  field(CLCM, "(A+((C-A)*((D-H)/(D-E))))") # Jaw set 3
  field(CLCN, "(A+((C-A)*((D-I)/(D-E))))") # Jaw set 4
  field(CLCO, "(A+((C-A)*((D-J)/(D-E))))") # Jaw set 5
  
  field(OUTK, "$(P)MOT:JAWS1:HGAP:SP PP")
  field(OUTL, "$(P)MOT:JAWS2:HGAP:SP PP")
  field(OUTM, "$(P)MOT:JAWS3:HGAP:SP PP")
  field(OUTN, "$(P)MOT:JAWS4:HGAP:SP PP")
  field(OUTO, "$(P)POLJAWSET:JAWS5:HGAP PP")
  
}

record(transform, "$(P)POLJAWSET:VGAP:_FAN") {

  field(INPA, "$(P)POLJAWSET:VGAP:SP")
  field(INPB, "$(P)MOT:JAWS5:VGAP:SP")
  field(INPC, "$(COL_HEIGHT)") 
  field(INPD, "$(MOD_TO_SAMPLE)")
  field(INPE, "$(MOD_TO_COL)")
  field(INPF, "$(MOD_TO_JAWS1)")
  field(INPG, "$(MOD_TO_JAWS2)")
  field(INPH, "$(MOD_TO_JAWS3)")
  field(INPI, "$(MOD_TO_JAWS4)")
  field(INPJ, "$(MOD_TO_JAWS5)") 
  
  field(CLCK, "(A+((C-A)*((D-F)/(D-E))))") # Jaw set 1
  field(CLCL, "(A+((C-A)*((D-G)/(D-E))))") # Jaw set 2
  field(CLCM, "(A+((C-A)*((D-H)/(D-E))))") # Jaw set 3
  field(CLCN, "(A+((C-A)*((D-I)/(D-E))))") # Jaw set 4
  field(CLCO, "(A+((C-A)*((D-J)/(D-E))))") # Jaw set 5
  
  field(OUTK, "$(P)MOT:JAWS1:VGAP:SP PP")
  field(OUTL, "$(P)MOT:JAWS2:VGAP:SP PP")
  field(OUTM, "$(P)MOT:JAWS3:VGAP:SP PP")
  field(OUTN, "$(P)MOT:JAWS4:VGAP:SP PP")
  field(OUTO, "$(P)POLJAWSET:JAWS5:VGAP PP")
  
}

record(ao, "$(P)POLJAWSET:VCENT:SP") {
  field(DESC, "Global Vertical Setpoint")
  field(FLNK, "$(P)POLJAWSET:VCENT:_FAN")
  field(PREC, "2")
  field(EGU, "")
}

record(ao, "$(P)POLJAWSET:HCENT:SP") {
  field(DESC, "Global Horizontal Setpoint")
  field(FLNK, "$(P)POLJAWSET:HCENT:_FAN")
  field(PREC, "2")
  field(EGU, "")  
}

record(dfanout,"$(P)POLJAWSET:VCENT:_FAN") {
  field(DOL, "$(P)POLJAWSET:VCENT:SP PP")
  field(OMSL, "closed_loop")
 
  field(OUTA, "$(P)MOT:JAWS1:VCENT:SP PP")
  field(OUTB, "$(P)MOT:JAWS2:VCENT:SP PP")
  field(OUTC, "$(P)MOT:JAWS3:VCENT:SP PP")
  field(OUTD, "$(P)MOT:JAWS4:VCENT:SP PP")
  field(OUTE, "$(P)POLJAWSET:JAWS5:VCENT PP")
}

record(dfanout,"$(P)POLJAWSET:HCENT:_FAN") {
  field(DOL, "$(P)POLJAWSET:HCENT:SP PP")
  field(OMSL, "closed_loop")
    
  field(OUTA, "$(P)MOT:JAWS1:HCENT:SP PP")
  field(OUTB, "$(P)MOT:JAWS2:HCENT:SP PP")
  field(OUTC, "$(P)MOT:JAWS3:HCENT:SP PP")
  field(OUTD, "$(P)MOT:JAWS4:HCENT:SP PP")
  field(OUTE, "$(P)POLJAWSET:JAWS5:HCENT PP")
}

record(ao, "$(P)POLJAWSET:JAWS5:VGAP") {
  field(ASG, "MANAGER")
  field(DESC, "Jaws 5 calculated height")
  field(SCAN, "Passive")
  field(PINI, "YES")
  field(PREC, "3")
  field(EGU, "")
  info(archive, "VAL")
}

record(ao, "$(P)POLJAWSET:JAWS5:HGAP") {
  field(ASG, "MANAGER")
  field(DESC, "Jaws 5 calculated width")
  field(SCAN, "Passive")
  field(PINI, "YES")
  field(PREC, "3")
  field(EGU, "")
  info(archive, "VAL")
}

record(ao, "$(P)POLJAWSET:JAWS5:VCENT") {
  field(ASG, "MANAGER")
  field(DESC, "Jaws 5 calculated verti centre")
  field(SCAN, "Passive")
  field(PINI, "YES")
  field(PREC, "3")
  field(EGU, "")
  info(archive, "VAL")
}

record(ao, "$(P)POLJAWSET:JAWS5:HCENT") {
  field(ASG, "MANAGER")
  field(DESC, "Jaws 5 calculated horiz centre")
  field(SCAN, "Passive")
  field(PINI, "YES")
  field(PREC, "3")
  field(EGU, "")
  info(archive, "VAL")
}
  
record(seq, "$(P)POLJAWSET:JAWS5:SET") {
  field(ASG, "MANAGER")
  
  field(DOL1, "$(P)POLJAWSET:JAWS5:VGAP")
  field(DOL2, "$(P)POLJAWSET:JAWS5:HGAP")
  field(DOL3, "$(P)POLJAWSET:JAWS5:VCENT")
  field(DOL4, "$(P)POLJAWSET:JAWS5:HCENT")
  
  field(LNK1, "$(P)MOT:JAWS5:VGAP:SP PP")
  field(LNK2, "$(P)MOT:JAWS5:HGAP:SP PP")
  field(LNK3, "$(P)MOT:JAWS5:VCENT:SP PP")
  field(LNK4, "$(P)MOT:JAWS5:HCENT:SP PP")
}
